$(document).ready(function(){function init_app(){console.log("init_app"),"Logged In"==s?list_tasks():("Logged Out"===s&&$(".app-user").is(":visible")&&$(".app-user").fadeOut(300),$("#login_form").delay(500).fadeIn(300))}function pad(e,t){return e=e.toString(),e.length<t?pad("0"+e,t):e}function check_user_status(e){console.log("init check_user_status");var n={func:"Check User Status"};$.ajax({method:"GET",cache:!1,tryCount:0,retryLimit:3,timeout:5e3,url:"/cgi-bin/concord.pl",contentType:"application/json; charset=utf-8",data:n,dataType:"JSON",error:function(e,t,s){"timeout"===t&&$("div#tasks_loading pre").text("Your Request Timed out. Check your internet connection and try again."),console.log("responseText: "+e.responseText+", textStatus: "+t+", errorThrown: "+s)},beforeSend:function(){$("div#tasks_loading pre").text("Checking User Status..."),$("#tasks_loading").fadeIn(300)},success:function(n){n.error?console.log("Something went wrong: "+n.error):(t=n.user,s=n.userStatus,a=n.techID,console.log("userStatus: "+s),"Logged Out"===s&&$(".app-user").is(":visible")?$(".app-user").fadeOut(300):"Logged In"===s&&$(".app-user").is(":hidden")&&($("#app-user").text(t),$("#app-tech-id").text(a),$(".app-user").fadeIn(300)),"init"==e&&($("#tasks_loading").fadeOut(300),init_app()),"get tasks"==e&&("Logged In"==s?get_tasks():$("#tasks_loading").fadeOut(300,function(){$("#login_form").delay(500).fadeIn(300),$("div#loginResult").removeClass("alert-success"),$("div#loginResult").removeClass("alert-info"),$("div#loginResult pre").text("Please Login Again. Your session has ended."),$("div#loginResult").addClass("alert-danger")})),"upload tasks"==e&&("Logged In"==s?upload_tasks():$("#tasks_loading").fadeOut(300,function(){$("#login_form").delay(500).fadeIn(300),$("div#loginResult").removeClass("alert-success"),$("div#loginResult").removeClass("alert-info"),$("div#loginResult pre").text("Please Login Again. Your session has ended."),$("div#loginResult").addClass("alert-danger")})))}})}function add_task(){console.log("init add_task"),$("#key").val(""),$("#taskID").val(""),$("#name").val(""),$("#deviceName").val(""),$("#serial").val(""),$("#address1").val(""),$("#address2").val(""),$("#city").val(""),$("#state").val(""),$("#zip").val(""),$("#comments").val(""),$("#deviceType").val(""),$('#task_form input[type="checkbox"]').prop("checked",!1),$('#task_form input[type="radio"]').prop("checked",!1),$("#task_form h2").text("Add Task"),$("#tasks").fadeOut(300,function(){$("#task_form").fadeIn(300,function(){$("html, body").animate({scrollTop:0},"fast")})})}function edit_task(t){if(console.log("init edit_task"),0==n){var s=e.transaction(["task"],"readwrite").objectStore("task").get(t);s.onsuccess=function(e){var t=s.result;$("#task_form h2").text("Edit Task"),$("#key").val(t.id),$("#taskID").val(t.taskID),$("#name").val(t.name),$("#deviceName").val(t.deviceName),$("#serial").val(t.serial),$("#address1").val(t.address.streetAddress1),$("#address2").val(t.address.streetAddress2),$("#city").val(t.address.city),$("#state").val(t.address.state),$("#zip").val(t.address.postalCode),$("#comments").val(t.comments),$("#deviceType").val(t.deviceType),$('input[name="inlinecheckboxes[]"]').each(function(){var e=$(this);$.inArray(e.val(),t.inlinecheckboxes)>-1?e.prop("checked",!0):e.prop("checked",!1)}),$('input[name="checkboxes[]"]').each(function(){var e=$(this);$.inArray(e.val(),t.checkboxes)>-1?e.prop("checked",!0):e.prop("checked",!1)}),$('input[name="inlineradios"]').each(function(){var e=$(this);t.inlineradios===e.val()?e.prop("checked",!0):e.prop("checked",!1)}),$('input[name="radios"]').each(function(){var e=$(this);t.radios===e.val()?e.prop("checked",!0):e.prop("checked",!1)}),$("#tasks").fadeOut(300,function(){$("#task_form").fadeIn(300,function(){$("html, body").animate({scrollTop:0},"fast")})})}}else console.log("No tasks to edit")}function save_task(){console.log("init save_task");var t=e.transaction(["task"]).objectStore("task"),s=t.count();s.onsuccess=function(){var t=$("#key").val(),n=$("#name").val(),o=$("#deviceName").val(),i=$("#serial").val(),r=$("#address1").val(),d=$("#address2").val(),c=$("#city").val(),l=$("#state").val(),u=$("#zip").val(),k=$("#comments").val(),p=$("#deviceType").val(),f=$('input[type="checkbox"][name="inlinecheckboxes[]"]:checked').map(function(){return this.value}).get(),g=$('input[type="checkbox"][name="checkboxes[]"]:checked').map(function(){return this.value}).get(),v=$('input:checked[name="inlineradios"]').val(),m=$('input:checked[name="radios"]').val(),h=$("#taskID").val(),_=h.substring(0,4),x=h.substring(4,5),y=h.substring(5);"x"===x&&(x="u"),h=_+x+y,""===h&&(h=a+"n"+pad(Number(s.result)+1,4));var b={streetAddress1:r,streetAddress2:d,city:c,state:l,postalCode:u},T=e.transaction(["task"],"readwrite");""===t?T.objectStore("task").add({taskID:h,name:n,deviceName:o,serial:i,address:b,comments:k,deviceType:p,inlinecheckboxes:f,checkboxes:g,inlineradios:v,radios:m}):T.objectStore("task").put({id:Number(t),taskID:h,name:n,deviceName:o,serial:i,address:b,comments:k,deviceType:p,inlinecheckboxes:f,checkboxes:g,inlineradios:v,radios:m}),T.oncomplete=function(e){$("#task_form").fadeOut(300,function(){$("div#tasks_loading pre").text("Task Saved."),$("#tasks_loading").fadeIn(300,function(){list_tasks()})})}}}function delete_task(t){console.log("init delete_task");var s=$(t)[0],a=e.transaction(["task"],"readwrite");a.objectStore("task").delete(t);a.oncomplete=function(e){console.log("Deleted record: "+t),$("#"+s).find("td").fadeOut(300,function(){$("#"+s).remove()})}}function get_tasks(){console.log("init get_tasks"),$("#tasks").delay(500).fadeOut(300,function(){});var e={func:"Get Tasks"};$.ajax({method:"GET",cache:!1,tryCount:0,retryLimit:3,url:"/cgi-bin/concord.pl",contentType:"application/json; charset=utf-8",data:e,dataType:"JSON",error:function(e,t,s){console.log("responseText: "+e.responseText+", textStatus: "+t+", errorThrown: "+s)},beforeSend:function(){},success:function(e){e.error?console.log("Something went wrong. "+e.error):(""===e.tasks?$("div#tasks_loading pre").text("No new tasks on the server for you."):$("div#tasks_loading pre").text("Compiling Task Data..."),DB_to_indexedDB(e))}})}function DB_to_indexedDB(t){if(console.log("init DB_to_indexedDB"),""===t.tasks)setTimeout(list_tasks(),1e3),n=!0;else{n=!1;var s=e.transaction(["task"],"readonly"),a=s.objectStore("task"),o=a.openCursor(),r=[],d=[];o.onsuccess=function(s){var a=s.target.result;if(a)r.push(a.value.taskID),d.push(a.key),a.continue();else{var n=t.tasks.length,o=0;for(i=0;i<t.tasks.length;i++){var c=t.tasks[i].taskID,l=t.tasks[i].name,u=t.tasks[i].deviceName,k=t.tasks[i].serial,p=t.tasks[i].address,f=t.tasks[i].comments,g=t.tasks[i].deviceType,v=t.tasks[i].inlinecheckboxes,$=t.tasks[i].checkboxes,m=t.tasks[i].inlineradios,h=t.tasks[i].radios,_=e.transaction(["task"],"readwrite"),x=_.objectStore("task"),y={taskID:c,name:l,deviceName:u,serial:k,address:p,comments:f,deviceType:g,inlinecheckboxes:v,checkboxes:$,inlineradios:m,radios:h};if(-1===r.indexOf(y.taskID)){var b=x.add({taskID:c,name:l,deviceName:u,serial:k,address:p,comments:f,deviceType:g,inlinecheckboxes:v,checkboxes:$,inlineradios:m,radios:h});b.onerror=function(e){console.log("Error",e.target.error.name)},b.onsuccess=function(e){o++,console.log("Added new task to the indexedDB!"),o==n&&setTimeout(list_tasks(),1e3)}}else{var T=r.indexOf(y.taskID),b=x.put({id:d[T],taskID:c,name:l,deviceName:u,serial:k,address:p,comments:f,deviceType:g,inlinecheckboxes:v,checkboxes:$,inlineradios:m,radios:h});b.onerror=function(e){console.log("Error",e.target.error.name)},b.onsuccess=function(e){o++,console.log("Updated a task in the indexedDB!"),o==n&&setTimeout(function(){list_tasks()},1e3)}}}}}}}function list_tasks(t){console.log("init list_tasks");var s=e.transaction(["task"],"readonly"),a=s.objectStore("task"),o=a.openCursor(),i="";o.onsuccess=function(e){var s=e.target.result,o=a.count();o.onsuccess=function(){0!=o.result?s?(i+='<tr id="'+s.key+'" data-key="'+s.key+'">',i+='<td class="task_id">'+s.value.taskID+"</td>",i+='<td class="task_name">'+s.value.name+"</td>",i+='<td class="task_deviceName">'+s.value.deviceName+"</td>",i+='<td class="task_city">'+s.value.address.city+"</td>",i+='<td class="task_deviceType">'+s.value.deviceType+"</td>",i+='<td class="text-right"><a class="btn btn-primary edit">Edit</a> <a class="btn btn-danger delete">Delete</a></td>',i+="</tr>",s.continue()):($("#tasks_table tbody").empty().append(i),$("#tasks_loading").delay(500).fadeOut(300,function(){$("#tasks").delay(500).fadeIn(300,function(){$("html, body").animate({scrollTop:0},"fast")})})):(console.log("dbEmpty: "+n+"; check_for_more: "+t),n===!1&&void 0===t?(console.log("indexedDb is empty, and we want to check the server DB"),$("#tasks_loading").delay(500).fadeIn(300,function(){$("div#tasks_loading pre").text("Checking server for more tasks...")}),setTimeout(function(){get_tasks()},1e3)):(console.log("indexedDb is empty, and we are fine with that"),i+="<tr>",i+='<td colspan="6">There are no tasks on the server, or stored locally. Add One.</td>',i+="</tr>",$("#tasks_table tbody").empty().append(i),$("#tasks_loading").delay(500).fadeOut(300,function(){$("#tasks").delay(500).fadeIn(300,function(){$("html, body").animate({scrollTop:0},"fast")})})))}}}function upload_tasks(){console.log("init upload_tasks");var t=e.transaction(["task"],"readwrite"),s=t.objectStore("task"),a=s.openCursor(),o=new Array;a.onsuccess=function(t){var s=t.target.result;if(s)o.push(s.value),s.continue();else{var a=JSON.stringify(o);"[]"!=a?$.ajax({url:"/cgi-bin/upload.pl",method:"POST",processData:!1,contentType:"application/json; charset=utf-8",data:a,dataType:"JSON",cache:!1,error:function(e,t,s){console.log("responseText: "+e.responseText+", textStatus: "+t+", errorThrown: "+s)},beforeSend:function(){$("div#tasks_loading pre").text("Uploading Tasks..."),console.log("Upload Data: "+a)},success:function(t){if("error"==t.upload)console.log("Upload Response: "+t.upload_response),$("div#tasks_loading pre").text("Somthing happened. Upload failed...");else{console.log("Upload Response: "+t.upload_response);var s=e.transaction(["task"],"readwrite"),a=s.objectStore("task"),o=a.clear();o.onsuccess=function(e){console.log("indexedDB cleared"),n=!0,$("div#tasks_loading pre").text("Upload successful."),setTimeout(function(){list_tasks("no")},1e3)}}}}):(console.log("Nothing to Upload..."),$("div#tasks_loading pre").text("No tasks to upload..."),$("#tasks_loading").delay(1e3).fadeOut(300,function(){list_tasks("no")}))}}}function logout(){console.log("init logout");var e={func:"Logout"};$.ajax({method:"GET",cache:!1,tryCount:0,retryLimit:3,url:"/cgi-bin/concord.pl",contentType:"application/json; charset=utf-8",data:e,dataType:"JSON",error:function(e,t,s){console.log("responseText: "+e.responseText+", textStatus: "+t+", errorThrown: "+s)},beforeSend:function(){},success:function(e){e.error?console.log("Something went wrong. "+e.error):(s=e.userStatus,$("#tasks_loading").fadeOut(300,function(){$("div#loginResult pre").text("You successfully Logged Out."),$("div#loginResult").removeClass("alert-info"),$("div#loginResult").removeClass("alert-danger"),$("div#loginResult").addClass("alert-success").fadeIn(300),init_app()}))}})}if(console.log("v.0.8.0.12"),!window.indexedDB)return console.log("no indexedDB support"),void $("div#no_indexedDB").fadeIn(300);var e,t,s,a,n=!1,o=window.indexedDB.open("concord",100);o.onerror=function(e){console.log("Error opening db"),console.dir(e)},o.onupgradeneeded=function(e){var t,s=e.target.result;s.objectStoreNames.contains("task")||(console.log("ObjectStore UPDATED"),t=s.createObjectStore("task",{keyPath:"id",autoIncrement:!0}),t.createIndex("taskID","taskID",{unique:!0}),t.createIndex("name","name",{unique:!1}),t.createIndex("deviceName","deviceName",{unique:!1}),t.createIndex("serial","serial",{unique:!1}),t.createIndex("address","address",{unique:!1,multiEntry:!0}),t.createIndex("comments","comments",{unique:!1}),t.createIndex("deviceType","deviceType",{unique:!1}),t.createIndex("inlinecheckboxes","inlinecheckboxes",{unique:!1}),t.createIndex("checkboxes","checkboxes",{unique:!1}),t.createIndex("inlineradios","inlineradios",{unique:!1}),t.createIndex("radios","radios",{unique:!1}))},o.onsuccess=function(t){e=t.target.result,e.onerror=function(e){alert("Database error: "+e.target.errorCode)}},$("form#loginForm").submit(function(){var e=$("#inputEmail").prop("value"),t=$("#inputPassword").prop("value"),n="Login",o={username:e,password:t,func:n};return e&&t?(console.log("init Login Ajax request"),$.ajax({method:"GET",cache:!1,tryCount:0,retryLimit:3,url:"/cgi-bin/concord.pl",contentType:"application/json; charset=utf-8",data:o,dataType:"JSON",error:function(e,t,s){$("div#loginResult pre").text("responseText: "+e.responseText+", textStatus: "+t+", errorThrown: "+s),$("div#loginResult").addClass("alert-danger")},beforeSend:function(){console.log("Sending login info..."),$("div#loginResult").removeClass("alert-success"),$("div#loginResult").removeClass("alert-danger"),$("div#loginResult").hasClass("alert-info")||$("div#loginResult").addClass("alert-info"),$("div#loginResult pre").text("Loading...")},success:function(e){a=e.techID,s=e.userStatus,e.error?($("div#loginResult pre").text("Something went wrong. "+e.error),$("div#loginResult").addClass("alert-danger")):($("div#loginResult pre").text("Success! You're logged in now."),$("div#loginResult").removeClass("alert-info"),$("div#loginResult").addClass("alert-success"),$("#login_form").delay(500).fadeOut(300,function(){list_tasks(),$(".app-user").fadeIn(300)}))}})):($("div#loginResult pre").text("enter username and password"),$("div#loginResult").removeClass("alert-danger"),$("div#loginResult").removeClass("alert-info"),$("div#loginResult").addClass("alert-danger")),$("div#loginResult").fadeIn(300),!1}),$(document).on("click","a.action_logout",function(e){return $("#tasks").fadeOut(300,function(){$("#task_form").fadeOut(300,function(){$("div#tasks_loading pre").text("Logging out..."),$("#tasks_loading").fadeIn(300,function(){logout()})})}),!1}),$(document).on("click","a.action_get_tasks",function(e){return $("#tasks").fadeOut(300,function(){$("div#tasks_loading pre").text("Checking the server for tasks..."),$("#tasks_loading").fadeIn(300,function(){check_user_status("get tasks")})}),!1}),$(document).on("click","a.action_upload_tasks",function(e){return $("#tasks").fadeOut(300,function(){$("div#tasks_loading pre").text("Checking the server for tasks..."),$("#tasks_loading").fadeIn(300,function(){check_user_status("upload tasks")})}),!1}),$(document).on("click","a.action_add_task",function(e){return add_task(),!1}),$("#tasks_table").on("click","a.edit",function(e){var t=$(this).parent().parent().data("key");return edit_task(t),!1}),$("#tasks_table").on("click","td",function(e){var t=$(this).parent().data("key");return edit_task(t),!1}),$("#tasks_table").on("click","a.delete",function(e){var t=$(this).parent().parent().data("key");return delete_task(t),!1}),$(document).on("click","a.action_cancel_task",function(e){$("#task_form").fadeOut(300,function(){$("#tasks").fadeIn(300,function(){$("html, body").animate({scrollTop:0},"fast")})})}),$(document).on("click","a.action_save_task",function(e){return save_task(),!1}),check_user_status("init")});